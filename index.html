<script>
/* =========================
   UPGRADE ENGINE v3
   Filters + Recent Glow + Traffic Tiers + Heatmap + CSV + Click Tracking
========================= */

// =========================
// CATEGORY RULES
// =========================
const CATEGORY_RULES = [
  { key:"payment", cat:"Payments" },
  { key:"crypto", cat:"Payments" },
  { key:"pos", cat:"Payments" },

  { key:"plumber", cat:"Home" },
  { key:"hvac", cat:"Home" },
  { key:"roof", cat:"Home" },
  { key:"foundation", cat:"Home" },
  { key:"solar", cat:"Home" },
  { key:"pool", cat:"Home" },
  { key:"pest", cat:"Home" },

  { key:"auto", cat:"Auto" },
  { key:"towing", cat:"Auto" },
  { key:"mobile-detailing", cat:"Auto" },

  { key:"ai", cat:"Tech" },
  { key:"software", cat:"Tech" },
  { key:"app", cat:"Tech" },
  { key:"seo", cat:"Tech" },

  { key:"medical", cat:"Medical" },
  { key:"dental", cat:"Medical" },
  { key:"chiropractor", cat:"Medical" },
  { key:"gym", cat:"Medical" }
];

// =========================
// TRAFFIC TIERS
// =========================
const TRAFFIC_TIERS = [
  { key:"payment", tier:"HIGH" },
  { key:"plumber", tier:"HIGH" },
  { key:"hvac", tier:"HIGH" },
  { key:"roof", tier:"HIGH" },
  { key:"foundation", tier:"HIGH" },

  { key:"ai", tier:"MED" },
  { key:"software", tier:"MED" },
  { key:"solar", tier:"MED" },
  { key:"auto", tier:"MED" }
];

// =========================
// FILTER BAR + COUNTERS
// =========================
const header = document.querySelector("header");
const filterBar = document.createElement("div");
filterBar.style.marginTop = "10px";
filterBar.style.display = "flex";
filterBar.style.flexWrap = "wrap";
filterBar.style.gap = "8px";

const FILTERS = ["All","Payments","Home","Auto","Tech","Medical","Other"];
const FILTER_BTNS = {};

FILTERS.forEach(cat => {
  const btn = document.createElement("button");
  btn.dataset.cat = cat;
  btn.textContent = cat;
  btn.style.padding = "6px 14px";
  btn.style.borderRadius = "999px";
  btn.style.border = "1px solid rgba(0,0,0,.15)";
  btn.style.fontSize = "12px";
  btn.style.fontWeight = "800";
  btn.style.cursor = "pointer";
  btn.style.background = "white";

  btn.onclick = () => {
    document.querySelectorAll(".card").forEach(card => {
      const c = card.dataset.cat;
      card.style.display =
        (cat === "All" || c === cat) ? "flex" : "none";
    });
  };

  FILTER_BTNS[cat] = btn;
  filterBar.appendChild(btn);
});

header.appendChild(filterBar);

// =========================
// CARD ENHANCEMENT ENGINE
// =========================
setTimeout(() => {
  const cards = document.querySelectorAll(".card");
  const counter = { All:0, Payments:0, Home:0, Auto:0, Tech:0, Medical:0, Other:0 };

  cards.forEach(card => {
    const slugEl = card.querySelector(".slug");
    if (!slugEl) return;

    const slug = slugEl.innerText.toLowerCase();

    // -------- CATEGORY TAGGING --------
    let category = "Other";
    CATEGORY_RULES.forEach(rule => {
      if (slug.includes(rule.key)) category = rule.cat;
    });
    card.dataset.cat = category;
    counter[category]++;
    counter.All++;

    // -------- TRAFFIC TIER --------
    let tier = "LOW";
    TRAFFIC_TIERS.forEach(rule => {
      if (slug.includes(rule.key)) tier = rule.tier;
    });

    const tierBadge = document.createElement("div");
    tierBadge.innerText = tier;
    tierBadge.style.fontSize = "10px";
    tierBadge.style.fontWeight = "900";
    tierBadge.style.marginTop = "6px";
    tierBadge.style.padding = "4px 10px";
    tierBadge.style.borderRadius = "999px";
    tierBadge.style.width = "max-content";

    // -------- HEATMAP COLORS --------
    if (tier === "HIGH") {
      tierBadge.style.background = "#ff6a00";
      tierBadge.style.color = "white";
      tierBadge.style.boxShadow = "0 0 12px rgba(255,120,0,.7)";
      card.style.borderColor = "rgba(255,120,0,.6)";
    } else if (tier === "MED") {
      tierBadge.style.background = "#ffd000";
      tierBadge.style.color = "#4a3b00";
      card.style.borderColor = "rgba(255,208,0,.6)";
    } else {
      tierBadge.style.background = "#dfeef8";
      tierBadge.style.color = "#335";
    }

    card.appendChild(tierBadge);

    // -------- RECENT GLOW --------
    if (Math.random() > 0.82) {
      card.style.boxShadow = "0 0 18px rgba(0,255,180,.9)";
      const recent = document.createElement("div");
      recent.innerText = "NEW";
      recent.style.position = "absolute";
      recent.style.top = "10px";
      recent.style.right = "10px";
      recent.style.background = "#00ffa3";
      recent.style.padding = "4px 8px";
      recent.style.borderRadius = "999px";
      recent.style.fontSize = "10px";
      recent.style.fontWeight = "900";
      card.style.position = "relative";
      card.appendChild(recent);
    }

    // -------- CLICK TRACKING (LOCAL) --------
    card.addEventListener("click", () => {
      const clicks = JSON.parse(localStorage.getItem("sg-clicks") || "{}");
      clicks[slug] = (clicks[slug] || 0) + 1;
      localStorage.setItem("sg-clicks", JSON.stringify(clicks));
    });
  });

  // -------- UPDATE FILTER COUNTS --------
  Object.keys(counter).forEach(cat => {
    if (FILTER_BTNS[cat]) {
      FILTER_BTNS[cat].textContent = `${cat} (${counter[cat]})`;
    }
  });

}, 800);

// =========================
// ONE-CLICK SITEMAP GENERATOR (FIXED)
// =========================
function downloadSitemap() {
  const links = Array.from(document.querySelectorAll(".card"))
    .map(card => card.getAttribute("href"))
    .filter(Boolean);

  let xml =
`<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n`;

  links.forEach(l => {
    xml +=
`  <url>\n    <loc>${location.origin}/${l}</loc>\n    <changefreq>weekly</changefreq>\n    <priority>0.8</priority>\n  </url>\n`;
  });

  xml += "</urlset>";

  const blob = new Blob([xml], {type:"application/xml"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sitemap.xml";
  a.click();
}

// =========================
// CSV EXPORT OF ALL PAGES
// =========================
function downloadCSV() {
  const rows = [["Slug","Category","Traffic Tier","Clicks"]];
  const clicks = JSON.parse(localStorage.getItem("sg-clicks") || "{}");

  document.querySelectorAll(".card").forEach(card => {
    const slug = card.querySelector(".slug")?.innerText || "";
    const cat = card.dataset.cat || "Other";
    const tier = card.innerText.includes("HIGH") ? "HIGH" :
                 card.innerText.includes("MED") ? "MED" : "LOW";
    const clickCount = clicks[slug] || 0;

    rows.push([slug, cat, tier, clickCount]);
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type:"text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "sideguy-command-center.csv";
  a.click();
}
</script>
